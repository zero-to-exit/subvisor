# 프레임 추출 단계별 기준

## 전체 파이프라인 개요

```
수천 개의 프레임 (전체 영상)
  ↓ [단계 1: 초당 1프레임 추출 + 기본 필터링]
수십 개의 후보 프레임 (예: 30개)
  ↓ [단계 2: 장면 그룹화]
장면별 그룹
  ↓ [단계 3: 품질 평가 + 선택]
최종 선별된 프레임 (목표: 30개)
```

---

## 단계 1: 초당 1프레임 추출 단계

### 목표
- 전체 영상에서 **시간적으로 균등하게 분산된 후보 프레임** 수집
- 명백히 나쁜 품질의 프레임은 사전 필터링
- 최종 선별을 위한 충분한 후보 확보

### 적용 기준 (빠른 필터링)

#### ✅ 포함할 기준
1. **시간적 균등 분산**: 가능한 모든 초에서 최소 1개씩 추출 시도
2. **기본 품질 통과**: 빠른 품질 체크 통과

#### ❌ 제외할 기준 (명백히 나쁜 프레임)
1. **심한 블러**
   - Laplacian variance < 10
   - 초점이 완전히 나간 프레임

2. **심한 클리핑 (과노출/과소노출)**
   - 클리핑 비율 > 25%
   - 하이라이트 또는 섀도우가 대부분 날아간 프레임

3. **극단적 밝기**
   - 평균 밝기 < 30 (거의 검은 화면)
   - 평균 밝기 > 240 (거의 흰 화면)

### 대체 전략
만약 특정 초에서 프레임이 필터링되면:
- **옵션 1**: 필터링된 프레임을 포함 (시간 커버리지 우선)
- **옵션 2**: 근처 초(±0.5초)의 프레임 중 가장 좋은 것으로 대체
- **옵션 3**: 해당 초는 스킵하고 다음 단계에서 보정

### 현재 구현
- `quick_quality_check()`: 빠른 품질 체크 (3가지 기준)
- 필터링 통계 출력: 체크한 프레임 수, 통과/필터링 수

---

## 단계 2: 장면 그룹화 단계

### 목표
- 비슷한 장면의 프레임들을 그룹화
- 장면 전환 지점 감지

### 적용 기준
1. **장면 전환 감지** (PySceneDetect)
   - 시각적 변화가 큰 지점
   - 컷, 페이드 등 전환 감지

2. **장면별 그룹화**
   - 각 장면의 시작/끝 시간 기록
   - 추출된 프레임을 해당 장면에 할당

---

## 단계 3: 품질 평가 및 최종 선별 단계

### 목표
- 장면별로 **장면 길이 비율**에 따라 프레임 수 할당
- 각 장면 내에서 **품질 점수가 높은** 프레임 선택
- 정확히 목표 수(예: 30개)의 프레임 확보

### 적용 기준 (상세 품질 평가)

#### 품질 점수 계산 (`calculate_quality_score`)
1. **블러 (Sharpness)**
   - Laplacian variance
   - < 20: 0.3배, < 50: 0.7배, > 200: 1.2배

2. **클리핑**
   - 히스토그램 분석
   - > 15%: 0.5배, > 10%: 0.8배

3. **밝기 균형**
   - 평균 밝기 100-180 범위 선호
   - 100-180: 1.1배, < 50 or > 230: 0.6배

4. **대비 (Contrast)**
   - 표준 편차
   - > 30: 1.1배, < 15: 0.8배

5. **색상 풍부도**
   - BGR 채널 분산
   - > 25: 1.05배

#### 프레임 할당 로직
- 각 장면에 최소 1개씩 할당
- 남은 프레임은 장면 길이 비율로 할당
- 각 장면 내에서 품질 점수 높은 순으로 선택

---

## 권장 설정

### 초당 1프레임 단계
- **필터링 활성화**: `apply_quality_filter=True`
- **목적**: 시간 커버리지 유지 + 명백히 나쁜 프레임 제거
- **엄격도**: 낮음 (너무 엄격하면 시간 커버리지 손실)

### 최종 선별 단계
- **목적**: 정확한 수의 고품질 프레임 확보
- **엄격도**: 높음 (상세한 품질 평가)

---

## 개선 제안

### 시간 커버리지 보장
현재는 필터링된 프레임을 그냥 제외하는데, 다음 중 선택 가능:

1. **엄격한 필터링**: 나쁜 프레임 제외 (시간 커버리지 손실 가능)
2. **유연한 필터링**: 나쁜 프레임도 포함하되 품질 점수 낮게 부여 (다음 단계에서 자연스럽게 제외)
3. **대체 전략**: 필터링된 초에는 근처 초의 최고 품질 프레임으로 대체

### 품질 기준 확장
현재 기본 품질 체크에 추가 가능:
- 모션 블러 감지 (연속 프레임 비교)
- 노이즈 검출
- 해상도/비트레이트 체크

---

## 실행 결과 예시

```
[0/4] 프레임 추출 중... (초당 1프레임)
  체크한 프레임: 32개
  통과: 22개
  필터링됨: 10개  ← 나쁜 품질 프레임 제외

[1/4] 장면 전환 감지 중...
  ✅ 10개 장면 감지됨

[2/4] 프레임을 장면별로 그룹화 중...
  장면별 프레임 수: [4, 2, 2, 3, 3, 1, 1, 2, 4, 2]

[3/4] 각 장면에서 최고 품질 프레임 선택 중... (목표: 30개)
  장면 1: 4개 선택
  장면 2: 2개 선택
  ...
  ✅ 총 30개 프레임 선택됨
```

